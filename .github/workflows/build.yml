name: Publish to SPM

on:
  repository_dispatch:
    types: [trigger-publishSPM-workflow]

  workflow_dispatch:
    inputs:
      VERSION:
        description: 'SDK Version (e.g. 1.0.105)'
        required: true
      URL:
        description: 'SDK bundle zip download URL'
        required: true
      ARCHIVE_NAME:
        description: 'Bundle zip file name'
        required: true

jobs:
  publish:
    runs-on: macos-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Resolve inputs (auto / manual unified)
      # ------------------------------------------------------------
      - name: Resolve inputs
        run: |
          VERSION="${{ github.event.client_payload.version || inputs.VERSION }}"
          URL="${{ github.event.client_payload.url || inputs.URL }}"
          ARCHIVE="${{ github.event.client_payload.archive_name || inputs.ARCHIVE_NAME }}"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "URL=$URL" >> $GITHUB_ENV
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 3. Download & unzip SDK bundle
      # ------------------------------------------------------------
      - name: Download SDK bundle
        run: |
          curl -L -o "$ARCHIVE" "$URL"
          unzip "$ARCHIVE" -d extracted

      # ------------------------------------------------------------
      # 4. Locate folder containing xcframeworks
      #    ÔºàËá™Âä®ÂÖúÂ∫ïÔºö‰∏çÁÆ°Â§öÂåÖ‰∏ÄÂ±ÇÔºâ
      # ------------------------------------------------------------
      - name: Locate xcframework root
        run: |
          set -e
          ROOT=$(find extracted -type d -maxdepth 2 | while read d; do
            ls "$d"/*.xcframework >/dev/null 2>&1 && echo "$d" && break
          done)

          if [ -z "$ROOT" ]; then
            echo "‚ùå No xcframeworks found"
            exit 1
          fi

          echo "XC_ROOT=$ROOT" >> $GITHUB_ENV
          echo "‚úÖ xcframework root: $ROOT"

      # ------------------------------------------------------------
      # 5. Create SPM-compliant zip files
      #    Ôºàzip Ê†πÁõÆÂΩï = xxx.xcframeworkÔºâ
      # ------------------------------------------------------------
      - name: Create SPM zips
        run: |
          mkdir -p zips

          for f in "$XC_ROOT"/*.xcframework; do
            name=$(basename "$f")
            echo "üì¶ Zipping $name"

            (
              cd "$XC_ROOT"
              zip -r "$GITHUB_WORKSPACE/zips/${name}.zip" "$name"
            )
          done

      # ------------------------------------------------------------
      # 6. Validate zip structure (optional but recommended)
      # ------------------------------------------------------------
      - name: Validate SPM zip structure
        run: |
          for z in zips/*.zip; do
            echo "üîç $z"
            unzip -l "$z" | head -n 20
          done

      # ------------------------------------------------------------
      # 7. Update Package.swift (URL + checksum)
      # ------------------------------------------------------------
      - name: Update Package.swift
        run: |
          set -e
          for z in zips/*.zip; do
            name=$(basename "$z" .zip)
            checksum=$(swift package compute-checksum "$z")

            echo "‚úèÔ∏è Updating $name ($checksum)"

            sed -i '' "/name: \"$name\"/,/checksum:/ {
              s|url: \".*\"|url: \"https://github.com/${{ github.repository }}/releases/download/$VERSION/${name}.zip\"|
              s|checksum: \".*\"|checksum: \"$checksum\"|
            }" Package.swift
          done

      # ------------------------------------------------------------
      # 8. Commit & tag
      # ------------------------------------------------------------
      - name: Commit & tag
        run: |
          git add Package.swift
          git commit -m "release: $VERSION SPM binary update" || echo "No changes"

          git tag -f "$VERSION"
          git push origin main
          git push -f origin "$VERSION"

      # ------------------------------------------------------------
      # 9. Create GitHub Release & upload zips
      # ------------------------------------------------------------
      - name: üì¶ Upload release artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          files: zips/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN_COPY }}
