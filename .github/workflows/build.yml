name: Publish to SPM

on:
  workflow_dispatch:
    inputs:
      VERSION:
        description: 'SDK Version (e.g. 1.0.107)'
        required: true

      URL:
        description: 'ZIP File Download URL'
        required: true

      ARCHIVE_NAME:
        description: 'Archive file name (e.g. sdk.zip)'
        required: true

jobs:
  publish:
    runs-on: macos-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: üßæ Checkout repo
        uses: actions/checkout@v3

      # ------------------------------------------------------------
      # 2. Prepare directories
      # ------------------------------------------------------------
      - name: üìÅ Prepare workspace
        run: |
          mkdir -p downloaded extracted zips

      # ------------------------------------------------------------
      # 3. Download SDK archive
      # ------------------------------------------------------------
      - name: ‚¨áÔ∏è Download SDK artifacts
        run: |
          curl -L -o downloaded/${{ github.event.inputs.ARCHIVE_NAME }} \
            "${{ github.event.inputs.URL }}"

          unzip downloaded/${{ github.event.inputs.ARCHIVE_NAME }} -d extracted

      # ------------------------------------------------------------
      # 4. Replace xcframeworks in repo
      # ------------------------------------------------------------
      - name: üîÑ Replace xcframeworks
        run: |
          set -e
          DEST_DIR="IMQACore/Frameworks"
          rm -rf "$DEST_DIR"
          mkdir -p "$DEST_DIR"
          cp -R extracted/*.xcframework "$DEST_DIR"

      # ------------------------------------------------------------
      # 5. Zip xcframeworks (SPM-safe: ditto)
      # ------------------------------------------------------------
      - name: üì¶ Zip xcframeworks
        run: |
          set -e
          for f in IMQACore/Frameworks/*.xcframework; do
            name=$(basename "$f" .xcframework)
            ditto -c -k --sequesterRsrc --keepParent \
              "$f" "zips/${name}.xcframework.zip"
          done

      # ------------------------------------------------------------
      # 6. Compute checksums (single source of truth)
      # ------------------------------------------------------------
      - name: üßÆ Compute checksums
        run: |
          set -e
          echo "CHECKSUM_MAP<<EOF" >> $GITHUB_ENV
          for f in zips/*.zip; do
            name=$(basename "$f" .xcframework.zip)
            checksum=$(swift package compute-checksum "$f")
            echo "$name=$checksum"
          done >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # 7. Update Package.swift
      # ------------------------------------------------------------
      - name: üìù Update Package.swift
        run: |
          set -e
          VERSION="${{ github.event.inputs.VERSION }}"

          while IFS='=' read -r name checksum; do
            sed -i '' "/name: \"$name\",/,/checksum:/ {
              s|url: \".*\"|url: \"https://github.com/${{ github.repository }}/releases/download/${VERSION}/${name}.xcframework.zip\"|
              s|checksum: \".*\"|checksum: \"${checksum}\"|
            }" Package.swift
          done <<< "$CHECKSUM_MAP"

      # ------------------------------------------------------------
      # 8. Commit & tag (NO force, tag immutable)
      # ------------------------------------------------------------
      - name: üöÄ Commit & tag
        run: |
          set -e
          VERSION="${{ github.event.inputs.VERSION }}"
          git status
          git add Package.swift IMQACore/Frameworks  
          git commit -m "release(spm): ${VERSION}"
          git tag "${VERSION}"
          git push origin main
          git push origin "${VERSION}"

      # ------------------------------------------------------------
      # 9. Create GitHub Release (use PAT)
      # ------------------------------------------------------------
      - name: üì¶ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.VERSION }}
          files: zips/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN_COPY }}
